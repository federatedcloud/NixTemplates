Bootstrap: shub
From: federatedcloud/NixTemplates:nix_alpine_base_14e053b44868adf9413cad2c6394cfbdfb149b81

# For development:
# Bootstrap: localimage
# From: Base/nix_alpine_base_bc4bd803c3aaa8622b493bcf66190c3944706ec3_testing.img

%environment
export TRIGGER=1
export PATH="${PATH}:/usr/local/bin"

%setup

%files
$BASEDIR/config.nix /template/hometmp/.config/nixpkgs/
$BASEDIR/dev-env.nix $ENVSDIR/
Utils/persist-env.sh $ENVSDIR/
$BASEDIR/mpi4py_benchmarks $ENVSDIR/
$BASEDIR/entrypoint* $ENVSDIR/
$BASEDIR/default.nix $ENVSDIR/
$BASEDIR/default.sh $ENVSDIR/

%runscript

USER=$(whoami)
echo "runscript user is $USER"

# Run the base nix runscript to initialize nix
sh /.singularity.d/runscript-nixbase

# We need to overwrite the file from base
cp -R /template/hometmp/.config/nixpkgs/* $HOME/.config/nixpkgs/

$nixenv && cd /tmp && sh $ENVSDIR/persist-env.sh $ENVSDIR/dev-env.nix

# TODO: May need this later
# cp $BASEDIR/default-mca-params.conf ${HOME}/.openmpi/mca-params.conf

#TODO: check if "$@", if not, run default.sh
# exec /bin/sh "$@"
exec /bin/sh "/nixenv/nixuser/default.sh"
